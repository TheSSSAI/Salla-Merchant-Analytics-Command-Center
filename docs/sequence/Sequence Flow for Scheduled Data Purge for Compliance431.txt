# 1 Overview

## 1.1 Diagram Id

SEQ-OF-001

## 1.2 Name

Scheduled Data Purge for Compliance

## 1.3 Description

A scheduled job runs daily to enforce the system's data retention policies. It identifies and permanently deletes records that have exceeded their retention period, such as abandoned cart records older than 90 days.

## 1.4 Type

üîπ OperationalFlow

## 1.5 Purpose

To maintain data hygiene and comply with data retention policies (REQ-NFR-005) and privacy regulations by automatically purging stale data.

## 1.6 Complexity

Low

## 1.7 Priority

üü° Medium

## 1.8 Frequency

Daily

## 1.9 Participants

- scheduled-jobs-processor-015
- oltp-repository-008

## 1.10 Key Interactions

- A scheduled trigger (e.g., AWS EventBridge Schedule) invokes the processor function daily at a set time.
- The function executes a query on the OLTP database to find records older than their defined retention period (e.g., abandoned carts older than 90 days).
- The function deletes the identified records in batches to avoid overwhelming the database.
- The function logs a summary of the purge operation (e.g., 'Purged 1,234 abandoned cart records').

## 1.11 Triggers

- A daily cron-like schedule (e.g., 02:00 UTC).

## 1.12 Outcomes

- Stale data is regularly and automatically removed from the system.
- The system remains compliant with its stated data retention policy.
- Database storage growth is managed.

## 1.13 Business Rules

- Abandoned cart records are purged after 90 days if not converted (REQ-NFR-005).
- Analytical data is retained for 24 months (purged separately, if applicable).
- Data associated with a terminated account is deleted after a 90-day grace period.

## 1.14 Error Scenarios

- The delete query fails or times out; the job retries and alerts operations on persistent failure.
- The scheduled job fails to trigger, which is caught by monitoring.

## 1.15 Integration Points

*No items available*

# 2.0 Details

## 2.1 Diagram Id

SEQ-IMP-OF-001

## 2.2 Name

Implementation: Scheduled Data Purge for Compliance

## 2.3 Description

A detailed technical sequence for a daily scheduled job that enforces data retention policies. A cloud scheduler triggers a serverless function which connects to the OLTP database to delete records exceeding their retention period (e.g., abandoned carts older than 90 days) in controlled batches. The process includes comprehensive logging and metrics for observability and compliance auditing.

## 2.4 Participants

### 2.4.1 System Trigger

#### 2.4.1.1 Repository Id

cloud-scheduler-016

#### 2.4.1.2 Display Name

Cloud Scheduler

#### 2.4.1.3 Type

üîπ System Trigger

#### 2.4.1.4 Technology

AWS EventBridge Schedule

#### 2.4.1.5 Order

1

#### 2.4.1.6 Style

| Property | Value |
|----------|-------|
| Shape | actor |
| Color | #9A86A3 |
| Stereotype | Scheduler |

### 2.4.2.0 Serverless Function

#### 2.4.2.1 Repository Id

scheduled-jobs-processor-015

#### 2.4.2.2 Display Name

Scheduled Jobs Processor

#### 2.4.2.3 Type

üîπ Serverless Function

#### 2.4.2.4 Technology

AWS Lambda (Node.js 20.x)

#### 2.4.2.5 Order

2

#### 2.4.2.6 Style

| Property | Value |
|----------|-------|
| Shape | participant |
| Color | #D3CEDF |
| Stereotype | Background Process |

### 2.4.3.0 Repository

#### 2.4.3.1 Repository Id

oltp-repository-008

#### 2.4.3.2 Display Name

OLTP Repository

#### 2.4.3.3 Type

üîπ Repository

#### 2.4.3.4 Technology

Prisma 5.x / PostgreSQL 16

#### 2.4.3.5 Order

3

#### 2.4.3.6 Style

| Property | Value |
|----------|-------|
| Shape | database |
| Color | #B99B6B |
| Stereotype | Database |

### 2.4.4.0 Monitoring System

#### 2.4.4.1 Repository Id

observability-platform-017

#### 2.4.4.2 Display Name

Observability Platform

#### 2.4.4.3 Type

üîπ Monitoring System

#### 2.4.4.4 Technology

AWS CloudWatch (Logs & Metrics)

#### 2.4.4.5 Order

4

#### 2.4.4.6 Style

| Property | Value |
|----------|-------|
| Shape | boundary |
| Color | #A2B5BB |
| Stereotype | Monitoring |

## 2.5.0.0 Interactions

### 2.5.1.0 Trigger

#### 2.5.1.1 Source Id

cloud-scheduler-016

#### 2.5.1.2 Target Id

scheduled-jobs-processor-015

#### 2.5.1.3 Message

invoke(ScheduledEvent)

#### 2.5.1.4 Sequence Number

1

#### 2.5.1.5 Type

üîπ Trigger

#### 2.5.1.6 Is Synchronous

‚úÖ Yes

#### 2.5.1.7 Return Message



#### 2.5.1.8 Has Return

‚ùå No

#### 2.5.1.9 Is Activation

‚úÖ Yes

#### 2.5.1.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | AWS Event |
| Method | Lambda Invoke |
| Parameters | ScheduledEvent payload containing trigger details. |
| Authentication | IAM Role-based invocation policy. |
| Error Handling | Monitored via CloudWatch metrics for trigger failu... |
| Performance | N/A |

### 2.5.2.0 Logging

#### 2.5.2.1 Source Id

scheduled-jobs-processor-015

#### 2.5.2.2 Target Id

observability-platform-017

#### 2.5.2.3 Message

log('Data purge job started.')

#### 2.5.2.4 Sequence Number

2

#### 2.5.2.5 Type

üîπ Logging

#### 2.5.2.6 Is Synchronous

‚ùå No

#### 2.5.2.7 Return Message



#### 2.5.2.8 Has Return

‚ùå No

#### 2.5.2.9 Is Activation

‚ùå No

#### 2.5.2.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | stdout (JSON) |
| Method | winston.info() |
| Parameters | Structured log object with logLevel: 'info', messa... |
| Authentication | N/A |
| Error Handling | N/A |
| Performance | Fire-and-forget. |

### 2.5.3.0 Database Operation

#### 2.5.3.1 Source Id

scheduled-jobs-processor-015

#### 2.5.3.2 Target Id

oltp-repository-008

#### 2.5.3.3 Message

deleteExpiredAbandonedCarts(cutoffDate, batchSize)

#### 2.5.3.4 Sequence Number

3

#### 2.5.3.5 Type

üîπ Database Operation

#### 2.5.3.6 Is Synchronous

‚úÖ Yes

#### 2.5.3.7 Return Message

{ totalDeleted: number }

#### 2.5.3.8 Has Return

‚úÖ Yes

#### 2.5.3.9 Is Activation

‚úÖ Yes

#### 2.5.3.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | TCP/IP |
| Method | Repository Method Call |
| Parameters | cutoffDate: Date (now - 90 days), batchSize: numbe... |
| Authentication | IAM authentication for RDS, connection string from... |
| Error Handling | Throws PrismaClientKnownRequestError on failure. |
| Performance | Query should be optimized with an index on the cre... |

#### 2.5.3.11 Nested Interactions

- {'sourceId': 'oltp-repository-008', 'targetId': 'oltp-repository-008', 'message': '[LOOP] prisma.abandonedCart.deleteMany({ where: { createdAt: { lt: cutoffDate } }, take: batchSize })', 'sequenceNumber': 3.1, 'type': 'Internal Loop', 'isSynchronous': True, 'returnMessage': '{ count: number }', 'hasReturn': True, 'isActivation': False, 'technicalDetails': {'protocol': 'SQL', 'method': 'DELETE FROM', 'parameters': 'Batch delete operation with a WHERE clause on the creation date and a LIMIT.', 'authentication': 'N/A', 'errorHandling': 'Database query timeouts or constraint violations will throw an exception.', 'performance': 'Batch size is critical to avoid long-running transactions and table locks.'}}

### 2.5.4.0 Logging

#### 2.5.4.1 Source Id

scheduled-jobs-processor-015

#### 2.5.4.2 Target Id

observability-platform-017

#### 2.5.4.3 Message

log('Data purge job finished successfully.')

#### 2.5.4.4 Sequence Number

4

#### 2.5.4.5 Type

üîπ Logging

#### 2.5.4.6 Is Synchronous

‚ùå No

#### 2.5.4.7 Return Message



#### 2.5.4.8 Has Return

‚ùå No

#### 2.5.4.9 Is Activation

‚ùå No

#### 2.5.4.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | stdout (JSON) |
| Method | winston.info() |
| Parameters | Structured log with message and custom field { tot... |
| Authentication | N/A |
| Error Handling | N/A |
| Performance | Fire-and-forget. |

### 2.5.5.0 Monitoring

#### 2.5.5.1 Source Id

scheduled-jobs-processor-015

#### 2.5.5.2 Target Id

observability-platform-017

#### 2.5.5.3 Message

emitMetric('DataPurgeSuccess', 1, 'Count')

#### 2.5.5.4 Sequence Number

5

#### 2.5.5.5 Type

üîπ Monitoring

#### 2.5.5.6 Is Synchronous

‚ùå No

#### 2.5.5.7 Return Message



#### 2.5.5.8 Has Return

‚ùå No

#### 2.5.5.9 Is Activation

‚ùå No

#### 2.5.5.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | EMF (Embedded Metric Format) |
| Method | CloudWatch PutMetricData |
| Parameters | MetricName: 'DataPurgeSuccess', Value: 1, Unit: 'C... |
| Authentication | N/A |
| Error Handling | N/A |
| Performance | Asynchronous operation. |

## 2.6.0.0 Notes

### 2.6.1.0 Content

#### 2.6.1.1 Content

The delete operation is performed in a loop with a fixed batch size to prevent locking the database table for an extended period and to stay within Lambda's memory and execution time limits.

#### 2.6.1.2 Position

top-right

#### 2.6.1.3 Participant Id

oltp-repository-008

#### 2.6.1.4 Sequence Number

3.1

### 2.6.2.0 Content

#### 2.6.2.1 Content

If a database error occurs during the delete operation, the function will log the error, emit a 'DataPurgeFailure' metric, and terminate. The configured Lambda retry policy (e.g., 2 retries with backoff) will attempt to re-run the job. Persistent failures will trigger a CloudWatch alarm.

#### 2.6.2.2 Position

bottom-right

#### 2.6.2.3 Participant Id

scheduled-jobs-processor-015

#### 2.6.2.4 Sequence Number

3

## 2.7.0.0 Implementation Guidance

| Property | Value |
|----------|-------|
| Security Requirements | The Lambda function's IAM execution role must gran... |
| Performance Targets | The entire job must complete within the Lambda's c... |
| Error Handling Strategy | Transient database connection errors or timeouts s... |
| Testing Considerations | Unit tests should cover the date calculation logic... |
| Monitoring Requirements | A CloudWatch Dashboard must be created to monitor ... |
| Deployment Considerations | The Lambda function, EventBridge Schedule rule, an... |

