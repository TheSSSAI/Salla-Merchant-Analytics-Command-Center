# 1 Overview

## 1.1 Diagram Id

SEQ-AF-002

## 1.2 Name

User Password Reset Flow

## 1.3 Description

A user who has forgotten their password requests a reset. The system sends a time-sensitive, single-use link to their registered email address. The user clicks the link, is directed to a secure page where they can enter and confirm a new password, which then updates their account.

## 1.4 Type

üîπ AuthenticationFlow

## 1.5 Purpose

To provide a secure and user-friendly way for users to regain access to their account if they have forgotten their password.

## 1.6 Complexity

Low

## 1.7 Priority

üî¥ High

## 1.8 Frequency

OnDemand

## 1.9 Participants

- user-browser
- spa-frontend-001
- api-gateway-002
- user-management-service-003
- oltp-repository-008
- notification-gateway-009
- audit-logger-010

## 1.10 Key Interactions

- User enters their email in the 'Forgot Password' form.
- The auth service generates a unique, single-use reset token, stores its hash in the database with an expiry (e.g., 60 minutes), and associates it with the user.
- The notification gateway sends an email containing the password reset link with the token.
- User clicks the link, and the SPA reads the token from the URL.
- User submits the new password form.
- The API receives the token and new password. It validates the token is valid, not expired, and matches the user.
- The user's password hash is updated in the database, and the reset token is invalidated to prevent reuse.
- An audit event is logged for the successful password change.

## 1.11 Triggers

- User initiates the 'Forgot Password' process from the login page.

## 1.12 Outcomes

- The user's password is securely updated.
- The user can now log in with their new password.

## 1.13 Business Rules

- Password reset links must be time-sensitive and single-use.
- The new password must meet the system's complexity requirements (BR-002).

## 1.14 Error Scenarios

- User provides an email that does not exist in the system (a generic success message may be shown to prevent user enumeration).
- The reset link has expired or has already been used.
- The new password does not meet complexity rules, and a validation error is shown.

## 1.15 Integration Points

- Email Provider (via Notification Gateway).

# 2.0 Details

## 2.1 Diagram Id

SEQ-AF-002

## 2.2 Name

Implementation-Ready User Password Reset Flow

## 2.3 Description

Provides a comprehensive technical specification for the user password reset sequence. It covers the initial request, secure token generation and delivery, and the final password update, including all necessary security checks, data operations, and audit logging. This diagram is designed for direct implementation by development teams.

## 2.4 Participants

### 2.4.1 Actor

#### 2.4.1.1 Repository Id

user-browser

#### 2.4.1.2 Display Name

User Browser

#### 2.4.1.3 Type

üîπ Actor

#### 2.4.1.4 Technology

N/A

#### 2.4.1.5 Order

1

#### 2.4.1.6 Style

| Property | Value |
|----------|-------|
| Shape | actor |
| Color | #999999 |
| Stereotype | User |

### 2.4.2.0 FrontendApplication

#### 2.4.2.1 Repository Id

spa-frontend-001

#### 2.4.2.2 Display Name

Frontend SPA

#### 2.4.2.3 Type

üîπ FrontendApplication

#### 2.4.2.4 Technology

React 18, TypeScript 5.4

#### 2.4.2.5 Order

2

#### 2.4.2.6 Style

| Property | Value |
|----------|-------|
| Shape | rectangle |
| Color | #82C3EC |
| Stereotype | SPA |

### 2.4.3.0 Gateway

#### 2.4.3.1 Repository Id

api-gateway-002

#### 2.4.3.2 Display Name

API Gateway

#### 2.4.3.3 Type

üîπ Gateway

#### 2.4.3.4 Technology

AWS API Gateway

#### 2.4.3.5 Order

3

#### 2.4.3.6 Style

| Property | Value |
|----------|-------|
| Shape | rectangle |
| Color | #F29B6C |
| Stereotype | Gateway |

### 2.4.4.0 Serverless Function Group

#### 2.4.4.1 Repository Id

user-management-service-003

#### 2.4.4.2 Display Name

User Management Service

#### 2.4.4.3 Type

üîπ Serverless Function Group

#### 2.4.4.4 Technology

AWS Lambda, Node.js 20.x

#### 2.4.4.5 Order

4

#### 2.4.4.6 Style

| Property | Value |
|----------|-------|
| Shape | rectangle |
| Color | #B4A7D6 |
| Stereotype | Service |

### 2.4.5.0 Repository

#### 2.4.5.1 Repository Id

oltp-repository-008

#### 2.4.5.2 Display Name

OLTP Repository

#### 2.4.5.3 Type

üîπ Repository

#### 2.4.5.4 Technology

Prisma, PostgreSQL

#### 2.4.5.5 Order

5

#### 2.4.5.6 Style

| Property | Value |
|----------|-------|
| Shape | database |
| Color | #A4C2F4 |
| Stereotype | Database |

### 2.4.6.0 Gateway

#### 2.4.6.1 Repository Id

notification-gateway-009

#### 2.4.6.2 Display Name

Notification Gateway

#### 2.4.6.3 Type

üîπ Gateway

#### 2.4.6.4 Technology

AWS SES SDK

#### 2.4.6.5 Order

6

#### 2.4.6.6 Style

| Property | Value |
|----------|-------|
| Shape | rectangle |
| Color | #F6B26B |
| Stereotype | Gateway |

### 2.4.7.0 Service

#### 2.4.7.1 Repository Id

audit-logger-010

#### 2.4.7.2 Display Name

Audit Logger

#### 2.4.7.3 Type

üîπ Service

#### 2.4.7.4 Technology

Winston, TypeScript

#### 2.4.7.5 Order

7

#### 2.4.7.6 Style

| Property | Value |
|----------|-------|
| Shape | rectangle |
| Color | #FFE599 |
| Stereotype | Logger |

## 2.5.0.0 Interactions

### 2.5.1.0 User Interaction

#### 2.5.1.1 Source Id

user-browser

#### 2.5.1.2 Target Id

spa-frontend-001

#### 2.5.1.3 Message

1. Submits email in 'Forgot Password' form

#### 2.5.1.4 Sequence Number

1

#### 2.5.1.5 Type

üîπ User Interaction

#### 2.5.1.6 Is Synchronous

‚úÖ Yes

#### 2.5.1.7 Return Message



#### 2.5.1.8 Has Return

‚ùå No

#### 2.5.1.9 Is Activation

‚úÖ Yes

#### 2.5.1.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | User Input |
| Method | Form Submit |
| Parameters | Payload: { email: string } |
| Authentication | N/A |
| Error Handling | Client-side validation for email format. |
| Performance | N/A |

### 2.5.2.0 API Call

#### 2.5.2.1 Source Id

spa-frontend-001

#### 2.5.2.2 Target Id

api-gateway-002

#### 2.5.2.3 Message

2. Request password reset

#### 2.5.2.4 Sequence Number

2

#### 2.5.2.5 Type

üîπ API Call

#### 2.5.2.6 Is Synchronous

‚úÖ Yes

#### 2.5.2.7 Return Message

3. HTTP 204 No Content

#### 2.5.2.8 Has Return

‚úÖ Yes

#### 2.5.2.9 Is Activation

‚úÖ Yes

#### 2.5.2.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTPS |
| Method | POST /api/v1/auth/forgot-password |
| Parameters | Body: { email: string } |
| Authentication | N/A (Public Endpoint) |
| Error Handling | Handles 204 response. Displays generic success mes... |
| Performance | p99 < 1000ms |

### 2.5.3.0 Service Invocation

#### 2.5.3.1 Source Id

api-gateway-002

#### 2.5.3.2 Target Id

user-management-service-003

#### 2.5.3.3 Message

2.1. Forward request

#### 2.5.3.4 Sequence Number

3

#### 2.5.3.5 Type

üîπ Service Invocation

#### 2.5.3.6 Is Synchronous

‚úÖ Yes

#### 2.5.3.7 Return Message

2.4. Return success status

#### 2.5.3.8 Has Return

‚úÖ Yes

#### 2.5.3.9 Is Activation

‚úÖ Yes

#### 2.5.3.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Internal (Lambda Invoke) |
| Method | handleForgotPasswordRequest |
| Parameters | event: { body: { email: string } } |
| Authentication | IAM Role |
| Error Handling | Propagates success status to the gateway. |
| Performance | p99 < 950ms |

#### 2.5.3.11 Nested Interactions

##### 2.5.3.11.1 Database Query

###### 2.5.3.11.1.1 Source Id

user-management-service-003

###### 2.5.3.11.1.2 Target Id

oltp-repository-008

###### 2.5.3.11.1.3 Message

2.1.1. Find user by email

###### 2.5.3.11.1.4 Sequence Number

4

###### 2.5.3.11.1.5 Type

üîπ Database Query

###### 2.5.3.11.1.6 Is Synchronous

‚úÖ Yes

###### 2.5.3.11.1.7 Return Message

2.1.2. Return user object or null

###### 2.5.3.11.1.8 Has Return

‚úÖ Yes

###### 2.5.3.11.1.9 Is Activation

‚úÖ Yes

###### 2.5.3.11.1.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Prisma Client |
| Method | prisma.user.findUnique |
| Parameters | query: { where: { email: string } } |
| Authentication | Database Credentials |
| Error Handling | Handles null return (user not found) gracefully. |
| Performance | p99 < 50ms |

##### 2.5.3.11.2.0 Internal Logic

###### 2.5.3.11.2.1 Source Id

user-management-service-003

###### 2.5.3.11.2.2 Target Id

user-management-service-003

###### 2.5.3.11.2.3 Message

2.1.3. IF user exists, generate and hash token

###### 2.5.3.11.2.4 Sequence Number

5

###### 2.5.3.11.2.5 Type

üîπ Internal Logic

###### 2.5.3.11.2.6 Is Synchronous

‚úÖ Yes

###### 2.5.3.11.2.7 Return Message



###### 2.5.3.11.2.8 Has Return

‚ùå No

###### 2.5.3.11.2.9 Technical Details

| Property | Value |
|----------|-------|
| Protocol | N/A |
| Method | generateResetToken |
| Parameters | 1. Generate 32-byte secure random token (crypto.ra... |
| Authentication | N/A |
| Error Handling | If user is null, skips to step 2.4 to return a gen... |
| Performance | p99 < 5ms |

##### 2.5.3.11.3.0 Database Update

###### 2.5.3.11.3.1 Source Id

user-management-service-003

###### 2.5.3.11.3.2 Target Id

oltp-repository-008

###### 2.5.3.11.3.3 Message

2.1.4. Store hashed token and expiry for user

###### 2.5.3.11.3.4 Sequence Number

6

###### 2.5.3.11.3.5 Type

üîπ Database Update

###### 2.5.3.11.3.6 Is Synchronous

‚úÖ Yes

###### 2.5.3.11.3.7 Return Message

2.1.5. Confirm update

###### 2.5.3.11.3.8 Has Return

‚úÖ Yes

###### 2.5.3.11.3.9 Is Activation

‚úÖ Yes

###### 2.5.3.11.3.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Prisma Client |
| Method | prisma.user.update |
| Parameters | query: { where: { id: userId }, data: { passwordRe... |
| Authentication | Database Credentials |
| Error Handling | Throws exception on database error. |
| Performance | p99 < 50ms |

##### 2.5.3.11.4.0 API Call

###### 2.5.3.11.4.1 Source Id

user-management-service-003

###### 2.5.3.11.4.2 Target Id

notification-gateway-009

###### 2.5.3.11.4.3 Message

2.2. Send password reset email

###### 2.5.3.11.4.4 Sequence Number

7

###### 2.5.3.11.4.5 Type

üîπ API Call

###### 2.5.3.11.4.6 Is Synchronous

‚úÖ Yes

###### 2.5.3.11.4.7 Return Message

2.3. Confirm email queued

###### 2.5.3.11.4.8 Has Return

‚úÖ Yes

###### 2.5.3.11.4.9 Is Activation

‚úÖ Yes

###### 2.5.3.11.4.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | AWS SDK |
| Method | ses.sendEmail |
| Parameters | { to: user.email, template: 'PasswordReset', templ... |
| Authentication | IAM Role |
| Error Handling | Implements retry logic for transient email provide... |
| Performance | p99 < 500ms |

### 2.5.4.0.0.0 UI Update

#### 2.5.4.1.0.0 Source Id

spa-frontend-001

#### 2.5.4.2.0.0 Target Id

user-browser

#### 2.5.4.3.0.0 Message

4. Display confirmation message

#### 2.5.4.4.0.0 Sequence Number

8

#### 2.5.4.5.0.0 Type

üîπ UI Update

#### 2.5.4.6.0.0 Is Synchronous

‚úÖ Yes

#### 2.5.4.7.0.0 Return Message



#### 2.5.4.8.0.0 Has Return

‚ùå No

#### 2.5.4.9.0.0 Technical Details

| Property | Value |
|----------|-------|
| Protocol | DOM Update |
| Method | render() |
| Parameters | Message: 'If an account with that email exists, a ... |
| Authentication | N/A |
| Error Handling | N/A |
| Performance | N/A |

### 2.5.5.0.0.0 User Interaction

#### 2.5.5.1.0.0 Source Id

user-browser

#### 2.5.5.2.0.0 Target Id

spa-frontend-001

#### 2.5.5.3.0.0 Message

5. Clicks link from email, loads page with token in URL

#### 2.5.5.4.0.0 Sequence Number

9

#### 2.5.5.5.0.0 Type

üîπ User Interaction

#### 2.5.5.6.0.0 Is Synchronous

‚úÖ Yes

#### 2.5.5.7.0.0 Return Message



#### 2.5.5.8.0.0 Has Return

‚ùå No

#### 2.5.5.9.0.0 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTP GET |
| Method | URL Navigation |
| Parameters | URL: /reset-password?token=<plaintextToken> |
| Authentication | N/A |
| Error Handling | SPA extracts token from query parameters. If no to... |
| Performance | LCP < 2.5s |

### 2.5.6.0.0.0 User Interaction

#### 2.5.6.1.0.0 Source Id

user-browser

#### 2.5.6.2.0.0 Target Id

spa-frontend-001

#### 2.5.6.3.0.0 Message

6. Submits new password

#### 2.5.6.4.0.0 Sequence Number

10

#### 2.5.6.5.0.0 Type

üîπ User Interaction

#### 2.5.6.6.0.0 Is Synchronous

‚úÖ Yes

#### 2.5.6.7.0.0 Return Message



#### 2.5.6.8.0.0 Has Return

‚ùå No

#### 2.5.6.9.0.0 Technical Details

| Property | Value |
|----------|-------|
| Protocol | User Input |
| Method | Form Submit |
| Parameters | Payload: { password: string, confirmPassword: stri... |
| Authentication | N/A |
| Error Handling | Client-side validation for password match and comp... |
| Performance | N/A |

### 2.5.7.0.0.0 API Call

#### 2.5.7.1.0.0 Source Id

spa-frontend-001

#### 2.5.7.2.0.0 Target Id

api-gateway-002

#### 2.5.7.3.0.0 Message

7. Send new password and token

#### 2.5.7.4.0.0 Sequence Number

11

#### 2.5.7.5.0.0 Type

üîπ API Call

#### 2.5.7.6.0.0 Is Synchronous

‚úÖ Yes

#### 2.5.7.7.0.0 Return Message

8. HTTP 200 OK

#### 2.5.7.8.0.0 Has Return

‚úÖ Yes

#### 2.5.7.9.0.0 Is Activation

‚úÖ Yes

#### 2.5.7.10.0.0 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTPS |
| Method | POST /api/v1/auth/reset-password |
| Parameters | Body: { token: string, newPassword: string } |
| Authentication | N/A (Public Endpoint) |
| Error Handling | Handles 400 (e.g., invalid token, password complex... |
| Performance | p99 < 1000ms |

### 2.5.8.0.0.0 Service Invocation

#### 2.5.8.1.0.0 Source Id

api-gateway-002

#### 2.5.8.2.0.0 Target Id

user-management-service-003

#### 2.5.8.3.0.0 Message

7.1. Forward reset request

#### 2.5.8.4.0.0 Sequence Number

12

#### 2.5.8.5.0.0 Type

üîπ Service Invocation

#### 2.5.8.6.0.0 Is Synchronous

‚úÖ Yes

#### 2.5.8.7.0.0 Return Message

7.5. Return success status

#### 2.5.8.8.0.0 Has Return

‚úÖ Yes

#### 2.5.8.9.0.0 Is Activation

‚úÖ Yes

#### 2.5.8.10.0.0 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Internal (Lambda Invoke) |
| Method | handleResetPassword |
| Parameters | event: { body: { token: string, newPassword: strin... |
| Authentication | IAM Role |
| Error Handling | Catches exceptions and maps them to appropriate HT... |
| Performance | p99 < 950ms |

#### 2.5.8.11.0.0 Nested Interactions

##### 2.5.8.11.1.0 Database Query

###### 2.5.8.11.1.1 Source Id

user-management-service-003

###### 2.5.8.11.1.2 Target Id

oltp-repository-008

###### 2.5.8.11.1.3 Message

7.1.1. Find user by hashed token

###### 2.5.8.11.1.4 Sequence Number

13

###### 2.5.8.11.1.5 Type

üîπ Database Query

###### 2.5.8.11.1.6 Is Synchronous

‚úÖ Yes

###### 2.5.8.11.1.7 Return Message

7.1.2. Return user object or null

###### 2.5.8.11.1.8 Has Return

‚úÖ Yes

###### 2.5.8.11.1.9 Is Activation

‚úÖ Yes

###### 2.5.8.11.1.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Prisma Client |
| Method | prisma.user.findFirst |
| Parameters | query: { where: { passwordResetToken: sha256(token... |
| Authentication | Database Credentials |
| Error Handling | Returns null if token is not found or is expired. |
| Performance | p99 < 50ms |

##### 2.5.8.11.2.0 Internal Logic

###### 2.5.8.11.2.1 Source Id

user-management-service-003

###### 2.5.8.11.2.2 Target Id

user-management-service-003

###### 2.5.8.11.2.3 Message

7.1.3. Validate token and new password (BR-002)

###### 2.5.8.11.2.4 Sequence Number

14

###### 2.5.8.11.2.5 Type

üîπ Internal Logic

###### 2.5.8.11.2.6 Is Synchronous

‚úÖ Yes

###### 2.5.8.11.2.7 Return Message



###### 2.5.8.11.2.8 Has Return

‚ùå No

###### 2.5.8.11.2.9 Technical Details

| Property | Value |
|----------|-------|
| Protocol | N/A |
| Method | validateResetRequest |
| Parameters | 1. Check if user object is null. If so, token is i... |
| Authentication | N/A |
| Error Handling | If validation fails, immediately return a 400 Bad ... |
| Performance | p99 < 5ms |

##### 2.5.8.11.3.0 Database Update

###### 2.5.8.11.3.1 Source Id

user-management-service-003

###### 2.5.8.11.3.2 Target Id

oltp-repository-008

###### 2.5.8.11.3.3 Message

7.2. Update password and invalidate token

###### 2.5.8.11.3.4 Sequence Number

15

###### 2.5.8.11.3.5 Type

üîπ Database Update

###### 2.5.8.11.3.6 Is Synchronous

‚úÖ Yes

###### 2.5.8.11.3.7 Return Message

7.3. Confirm update

###### 2.5.8.11.3.8 Has Return

‚úÖ Yes

###### 2.5.8.11.3.9 Is Activation

‚úÖ Yes

###### 2.5.8.11.3.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Prisma Client |
| Method | prisma.user.update |
| Parameters | query: { where: { id: userId }, data: { passwordHa... |
| Authentication | Database Credentials |
| Error Handling | Throws exception on database error. |
| Performance | p99 < 150ms (due to bcrypt) |

##### 2.5.8.11.4.0 Asynchronous Invocation

###### 2.5.8.11.4.1 Source Id

user-management-service-003

###### 2.5.8.11.4.2 Target Id

audit-logger-010

###### 2.5.8.11.4.3 Message

7.4. Log 'PasswordResetSuccess' event

###### 2.5.8.11.4.4 Sequence Number

16

###### 2.5.8.11.4.5 Type

üîπ Asynchronous Invocation

###### 2.5.8.11.4.6 Is Synchronous

‚ùå No

###### 2.5.8.11.4.7 Return Message



###### 2.5.8.11.4.8 Has Return

‚ùå No

###### 2.5.8.11.4.9 Is Activation

‚úÖ Yes

###### 2.5.8.11.4.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Internal (e.g., via SQS or direct async call) |
| Method | logEvent |
| Parameters | { eventType: 'PasswordResetSuccess', actingUserId:... |
| Authentication | IAM Role |
| Error Handling | Handled by the audit logging service with its own ... |
| Performance | N/A |

### 2.5.9.0.0.0 UI Update

#### 2.5.9.1.0.0 Source Id

spa-frontend-001

#### 2.5.9.2.0.0 Target Id

user-browser

#### 2.5.9.3.0.0 Message

9. Display success and redirect to login page

#### 2.5.9.4.0.0 Sequence Number

17

#### 2.5.9.5.0.0 Type

üîπ UI Update

#### 2.5.9.6.0.0 Is Synchronous

‚úÖ Yes

#### 2.5.9.7.0.0 Return Message



#### 2.5.9.8.0.0 Has Return

‚ùå No

#### 2.5.9.9.0.0 Technical Details

| Property | Value |
|----------|-------|
| Protocol | DOM Update & Navigation |
| Method | render() & history.push('/login') |
| Parameters | Message: 'Your password has been successfully rese... |
| Authentication | N/A |
| Error Handling | N/A |
| Performance | N/A |

## 2.6.0.0.0.0 Notes

### 2.6.1.0.0.0 Content

#### 2.6.1.1.0.0 Content

Security: The 'Forgot Password' endpoint (Step 2) MUST always return a generic success message to prevent user enumeration attacks. The response time should also be consistent whether the user exists or not.

#### 2.6.1.2.0.0 Position

Top

#### 2.6.1.3.0.0 Participant Id

*Not specified*

#### 2.6.1.4.0.0 Sequence Number

2

### 2.6.2.0.0.0 Content

#### 2.6.2.1.0.0 Content

Security: Reset tokens are stored in the database as a hash (e.g., SHA256) to mitigate the risk of a database leak exposing valid reset links. The plaintext token is only ever sent in the email.

#### 2.6.2.2.0.0 Position

Right

#### 2.6.2.3.0.0 Participant Id

oltp-repository-008

#### 2.6.2.4.0.0 Sequence Number

6

### 2.6.3.0.0.0 Content

#### 2.6.3.1.0.0 Content

Security: Upon successful password update, the reset token fields in the database MUST be set to null to ensure the token is single-use and immediately invalidated.

#### 2.6.3.2.0.0 Position

Right

#### 2.6.3.3.0.0 Participant Id

oltp-repository-008

#### 2.6.3.4.0.0 Sequence Number

15

## 2.7.0.0.0.0 Implementation Guidance

| Property | Value |
|----------|-------|
| Security Requirements | 1. Password Reset Token: Generate using a cryptogr... |
| Performance Targets | End-to-end time for a user to request a reset link... |
| Error Handling Strategy | 1. Email Not Found: The service should proceed as ... |
| Testing Considerations | 1. Test cases must cover the expiration logic by a... |
| Monitoring Requirements | 1. Monitor the rate of password reset requests. A ... |
| Deployment Considerations | Email templates used by the Notification Gateway s... |

