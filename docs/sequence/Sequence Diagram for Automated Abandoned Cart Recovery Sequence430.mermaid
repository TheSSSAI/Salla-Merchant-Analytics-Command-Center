sequenceDiagram
    participant "Salla E-commerce Platform" as SallaEcommercePlatform
    participant "OLTP Repository" as OLTPRepository
    participant "Scheduled Jobs Processor" as ScheduledJobsProcessor
    participant "Cart Recovery Service" as CartRecoveryService
    participant "Notification Gateway" as NotificationGateway

    SallaEcommercePlatform->>OLTPRepository: 1. 1. [Pre-condition] POST /webhook/cart/updated
    OLTPRepository-->>SallaEcommercePlatform: 200 OK
    activate ScheduledJobsProcessor
    ScheduledJobsProcessor->>ScheduledJobsProcessor: 2. 2. Hourly Trigger (e.g., cron(0 * * * ? *))
    ScheduledJobsProcessor->>OLTPRepository: 3. 3. findAbandonedCarts(criteria)
    OLTPRepository-->>ScheduledJobsProcessor: 4. Promise<Cart[]>
    activate CartRecoveryService
    ScheduledJobsProcessor->>CartRecoveryService: 5. 5. [Loop] processAbandonedCart(cart)
    CartRecoveryService-->>ScheduledJobsProcessor: 13. Promise<ProcessResult>
    CartRecoveryService->>OLTPRepository: 6. 6. getRecoveryContext(merchantId, customerEmail)
    OLTPRepository-->>CartRecoveryService: 7. Promise<RecoveryContext>
    CartRecoveryService->>CartRecoveryService: 8. 8. [Business Rule] Evaluate Campaign & Subscription
    CartRecoveryService->>NotificationGateway: 9. 9. sendEmail(emailRequest)
    NotificationGateway-->>CartRecoveryService: 10. Promise<SendStatus>
    CartRecoveryService->>OLTPRepository: 11. 11. updateCartRecoveryStatus(cartId, newStatus)
    OLTPRepository-->>CartRecoveryService: 12. Promise<UpdateResult>

    note over ScheduledJobsProcessor: Business Rule Enforcement (BR-003): The initial query in step 3 enforces the definition of an aba...
    note over CartRecoveryService: State Management: Step 11 is critical. It updates the state of the recovery process for a specifi...
    note over NotificationGateway: Unsubscribe Requirement (FR-503): The 'unsubscribeLink' is generated by the Cart Recovery Service...

    deactivate CartRecoveryService
    deactivate ScheduledJobsProcessor
