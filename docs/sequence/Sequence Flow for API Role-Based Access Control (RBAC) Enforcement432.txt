# 1 Overview

## 1.1 Diagram Id

SEQ-SF-001

## 1.2 Name

API Role-Based Access Control (RBAC) Enforcement

## 1.3 Description

A user makes an API request to a protected endpoint. The API Gateway and backend middleware inspect the user's JWT access token, extract their role for the specified merchant account, and verify if that role has the necessary permissions to perform the requested action. If not, the request is denied with a 403 Forbidden error.

## 1.4 Type

üîπ SecurityFlow

## 1.5 Purpose

To enforce the principle of least privilege by ensuring users can only access the data and perform the actions permitted by their assigned role (e.g., an 'Analyst' cannot configure cart recovery), as per REQ-OVR-003.

## 1.6 Complexity

Medium

## 1.7 Priority

üö® Critical

## 1.8 Frequency

OnDemand

## 1.9 Participants

- user-browser
- spa-frontend-001
- api-gateway-002
- user-management-service-003

## 1.10 Key Interactions

- The SPA makes an API call with the JWT in the 'Authorization: Bearer <token>' header.
- The API Gateway validates the JWT's signature and expiry using a public key.
- A custom authorizer or backend middleware decodes the JWT payload to extract userId and the target merchantId.
- The middleware queries the database to retrieve the user's role for that specific merchant account.
- The middleware checks a predefined permission map (e.g., RBAC configuration) to see if the user's role is allowed to access the requested endpoint and method (e.g., POST /campaigns).
- If authorized, the request is passed to the downstream service.
- If unauthorized, the request is rejected with a 403 Forbidden status.

## 1.11 Triggers

- Any API request to a protected endpoint that requires specific permissions.

## 1.12 Outcomes

- User actions are successfully restricted based on their role.
- Unauthorized access attempts are blocked and logged.

## 1.13 Business Rules

- Permissions for Owner, Admin, Analyst, and Marketer roles are strictly enforced (REQ-OVR-003).
- An 'Analyst' role has view-only access to analytics.
- A 'Marketer' role has access to the Cart Recovery module.

## 1.14 Error Scenarios

- User attempts an action not permitted for their role, receiving a 403 error.
- JWT is missing or invalid, resulting in a 401 Unauthorized error from the API Gateway.

## 1.15 Integration Points

*No items available*

# 2.0 Details

## 2.1 Diagram Id

SEQ-SF-001

## 2.2 Name

Implementation-Ready Sequence: API Role-Based Access Control (RBAC) Enforcement

## 2.3 Description

This diagram specifies the technical implementation for a defense-in-depth, Zero Trust based Role-Based Access Control (RBAC) check for a protected API endpoint. The sequence covers JWT validation at the edge (API Gateway) and fine-grained permission verification in the backend middleware, ensuring unauthorized access attempts are blocked and audited.

## 2.4 Participants

### 2.4.1 Client

#### 2.4.1.1 Repository Id

user-browser

#### 2.4.1.2 Display Name

User Browser

#### 2.4.1.3 Type

üîπ Client

#### 2.4.1.4 Technology

N/A

#### 2.4.1.5 Order

1

#### 2.4.1.6 Style

| Property | Value |
|----------|-------|
| Shape | actor |
| Color | #DDDDDD |
| Stereotype | Actor |

### 2.4.2.0 FrontendApplication

#### 2.4.2.1 Repository Id

spa-frontend-001

#### 2.4.2.2 Display Name

Frontend SPA

#### 2.4.2.3 Type

üîπ FrontendApplication

#### 2.4.2.4 Technology

React 18, TypeScript 5.4

#### 2.4.2.5 Order

2

#### 2.4.2.6 Style

| Property | Value |
|----------|-------|
| Shape | component |
| Color | #82E0AA |
| Stereotype | UI |

### 2.4.3.0 Gateway

#### 2.4.3.1 Repository Id

api-gateway-002

#### 2.4.3.2 Display Name

API Gateway

#### 2.4.3.3 Type

üîπ Gateway

#### 2.4.3.4 Technology

AWS API Gateway

#### 2.4.3.5 Order

3

#### 2.4.3.6 Style

| Property | Value |
|----------|-------|
| Shape | boundary |
| Color | #F8C471 |
| Stereotype | Gateway |

### 2.4.4.0 Serverless Function Group

#### 2.4.4.1 Repository Id

user-management-service-003

#### 2.4.4.2 Display Name

User Management Service (RBAC Middleware)

#### 2.4.4.3 Type

üîπ Serverless Function Group

#### 2.4.4.4 Technology

AWS Lambda, Node.js 20.x, TypeScript

#### 2.4.4.5 Order

4

#### 2.4.4.6 Style

| Property | Value |
|----------|-------|
| Shape | component |
| Color | #7FB3D5 |
| Stereotype | Service |

### 2.4.5.0 Repository

#### 2.4.5.1 Repository Id

oltp-repository-008

#### 2.4.5.2 Display Name

OLTP Repository

#### 2.4.5.3 Type

üîπ Repository

#### 2.4.5.4 Technology

Prisma, PostgreSQL

#### 2.4.5.5 Order

5

#### 2.4.5.6 Style

| Property | Value |
|----------|-------|
| Shape | database |
| Color | #D7BDE2 |
| Stereotype | Database |

### 2.4.6.0 Service

#### 2.4.6.1 Repository Id

audit-logger-010

#### 2.4.6.2 Display Name

Audit Logger

#### 2.4.6.3 Type

üîπ Service

#### 2.4.6.4 Technology

Winston, AWS CloudWatch Logs

#### 2.4.6.5 Order

6

#### 2.4.6.6 Style

| Property | Value |
|----------|-------|
| Shape | component |
| Color | #E59866 |
| Stereotype | Service |

## 2.5.0.0 Interactions

### 2.5.1.0 User Interaction

#### 2.5.1.1 Source Id

user-browser

#### 2.5.1.2 Target Id

spa-frontend-001

#### 2.5.1.3 Message

1. User initiates an action requiring protected data (e.g., clicks 'Edit Campaign').

#### 2.5.1.4 Sequence Number

1

#### 2.5.1.5 Type

üîπ User Interaction

#### 2.5.1.6 Is Synchronous

‚úÖ Yes

#### 2.5.1.7 Return Message



#### 2.5.1.8 Has Return

‚ùå No

#### 2.5.1.9 Is Activation

‚úÖ Yes

#### 2.5.1.10 Technical Details

*No data available*

### 2.5.2.0 API Request

#### 2.5.2.1 Source Id

spa-frontend-001

#### 2.5.2.2 Target Id

api-gateway-002

#### 2.5.2.3 Message

2. PUT /api/v1/campaigns/{campaignId}

#### 2.5.2.4 Sequence Number

2

#### 2.5.2.5 Type

üîπ API Request

#### 2.5.2.6 Is Synchronous

‚úÖ Yes

#### 2.5.2.7 Return Message

13. HTTP 200 OK | HTTP 403 Forbidden

#### 2.5.2.8 Has Return

‚úÖ Yes

#### 2.5.2.9 Is Activation

‚úÖ Yes

#### 2.5.2.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTPS/REST |
| Method | PUT |
| Parameters | Request body with campaign data. JWT Access Token ... |
| Authentication | Header: 'Authorization: Bearer <jwt_access_token>' |
| Error Handling | Client-side logic to handle 401, 403, and 5xx resp... |
| Performance | Request timeout: 15s. |

### 2.5.3.0 Security Validation

#### 2.5.3.1 Source Id

api-gateway-002

#### 2.5.3.2 Target Id

api-gateway-002

#### 2.5.3.3 Message

3. [Security Checkpoint] Validate JWT signature and expiry.

#### 2.5.3.4 Sequence Number

3

#### 2.5.3.5 Type

üîπ Security Validation

#### 2.5.3.6 Is Synchronous

‚úÖ Yes

#### 2.5.3.7 Return Message

If invalid: HTTP 401 Unauthorized

#### 2.5.3.8 Has Return

‚úÖ Yes

#### 2.5.3.9 Is Activation

‚úÖ Yes

#### 2.5.3.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Internal |
| Method | JWT Validation using JWKS |
| Parameters | Validates 'alg' (RS256), 'exp', and signature agai... |
| Authentication | N/A |
| Error Handling | Rejects request immediately with HTTP 401 if token... |
| Performance | Latency < 5ms (public key is cached). |

### 2.5.4.0 Service Invocation

#### 2.5.4.1 Source Id

api-gateway-002

#### 2.5.4.2 Target Id

user-management-service-003

#### 2.5.4.3 Message

4. Invoke RBAC Authorizer with request context.

#### 2.5.4.4 Sequence Number

4

#### 2.5.4.5 Type

üîπ Service Invocation

#### 2.5.4.6 Is Synchronous

‚úÖ Yes

#### 2.5.4.7 Return Message

12. Authorization Decision (Allow/Deny)

#### 2.5.4.8 Has Return

‚úÖ Yes

#### 2.5.4.9 Is Activation

‚úÖ Yes

#### 2.5.4.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | AWS Lambda Invocation |
| Method | invoke('handleAuthorization') |
| Parameters | Event object containing JWT claims (userId, mercha... |
| Authentication | IAM Role execution permissions. |
| Error Handling | Handles invocation failures; returns HTTP 500 if a... |
| Performance | Latency < 50ms for authorization logic. |

### 2.5.5.0 Database Query

#### 2.5.5.1 Source Id

user-management-service-003

#### 2.5.5.2 Target Id

oltp-repository-008

#### 2.5.5.3 Message

5. getUserRoleForMerchant(userId, merchantId)

#### 2.5.5.4 Sequence Number

5

#### 2.5.5.5 Type

üîπ Database Query

#### 2.5.5.6 Is Synchronous

‚úÖ Yes

#### 2.5.5.7 Return Message

6. UserRole object (e.g., { role: 'Marketer' })

#### 2.5.5.8 Has Return

‚úÖ Yes

#### 2.5.5.9 Is Activation

‚ùå No

#### 2.5.5.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Prisma Client |
| Method | prisma.userMerchantAccount.findUnique(...) |
| Parameters | { where: { userId_merchantId: { userId, merchantId... |
| Authentication | Database connection credentials from Secrets Manag... |
| Error Handling | Throws DatabaseError if connection fails or query ... |
| Performance | Query must be indexed for latency < 10ms. |

### 2.5.6.0 Permission Check

#### 2.5.6.1 Source Id

user-management-service-003

#### 2.5.6.2 Target Id

user-management-service-003

#### 2.5.6.3 Message

7. [Security Checkpoint] Verify permission against RBAC policy.

#### 2.5.6.4 Sequence Number

7

#### 2.5.6.5 Type

üîπ Permission Check

#### 2.5.6.6 Is Synchronous

‚úÖ Yes

#### 2.5.6.7 Return Message

Result: PERMITTED | DENIED

#### 2.5.6.8 Has Return

‚úÖ Yes

#### 2.5.6.9 Is Activation

‚úÖ Yes

#### 2.5.6.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Internal Logic |
| Method | isAllowed(role, resource, action) |
| Parameters | ('Marketer', 'campaigns', 'update') |
| Authentication | N/A |
| Error Handling | Defaults to DENIED if role or resource is not foun... |
| Performance | In-memory lookup, latency < 1ms. |

#### 2.5.6.11 Nested Interactions

##### 2.5.6.11.1 Audit Log

###### 2.5.6.11.1.1 Source Id

user-management-service-003

###### 2.5.6.11.1.2 Target Id

audit-logger-010

###### 2.5.6.11.1.3 Message

8. [ALT: Unauthorized] logEvent('AuthorizationFailure')

###### 2.5.6.11.1.4 Sequence Number

8

###### 2.5.6.11.1.5 Type

üîπ Audit Log

###### 2.5.6.11.1.6 Is Synchronous

‚ùå No

###### 2.5.6.11.1.7 Return Message



###### 2.5.6.11.1.8 Has Return

‚ùå No

###### 2.5.6.11.1.9 Is Activation

‚ùå No

###### 2.5.6.11.1.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Asynchronous Invocation/Queue |
| Method | logEvent() |
| Parameters | { eventType: 'AuthorizationFailure', actingUserId,... |
| Authentication | N/A |
| Error Handling | Logging failures should not block the main request... |
| Performance | N/A |

##### 2.5.6.11.2.0 Authorization Response

###### 2.5.6.11.2.1 Source Id

user-management-service-003

###### 2.5.6.11.2.2 Target Id

api-gateway-002

###### 2.5.6.11.2.3 Message

9. [ALT: Unauthorized] Return Deny Policy

###### 2.5.6.11.2.4 Sequence Number

9

###### 2.5.6.11.2.5 Type

üîπ Authorization Response

###### 2.5.6.11.2.6 Is Synchronous

‚úÖ Yes

###### 2.5.6.11.2.7 Return Message



###### 2.5.6.11.2.8 Has Return

‚ùå No

###### 2.5.6.11.2.9 Is Activation

‚ùå No

###### 2.5.6.11.2.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Internal |
| Method | N/A |
| Parameters | IAM policy document with 'Effect': 'Deny'. API Gat... |
| Authentication | N/A |
| Error Handling | N/A |
| Performance | N/A |

##### 2.5.6.11.3.0 Audit Log

###### 2.5.6.11.3.1 Source Id

user-management-service-003

###### 2.5.6.11.3.2 Target Id

audit-logger-010

###### 2.5.6.11.3.3 Message

10. [SUCCESS] logEvent('AuthorizationSuccess')

###### 2.5.6.11.3.4 Sequence Number

10

###### 2.5.6.11.3.5 Type

üîπ Audit Log

###### 2.5.6.11.3.6 Is Synchronous

‚ùå No

###### 2.5.6.11.3.7 Return Message



###### 2.5.6.11.3.8 Has Return

‚ùå No

###### 2.5.6.11.3.9 Is Activation

‚ùå No

###### 2.5.6.11.3.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Asynchronous Invocation/Queue |
| Method | logEvent() |
| Parameters | { eventType: 'AuthorizationSuccess', ... outcome: ... |
| Authentication | N/A |
| Error Handling | Logging failures should not block the main request... |
| Performance | N/A |

##### 2.5.6.11.4.0 Authorization Response

###### 2.5.6.11.4.1 Source Id

user-management-service-003

###### 2.5.6.11.4.2 Target Id

api-gateway-002

###### 2.5.6.11.4.3 Message

11. [SUCCESS] Return Allow Policy

###### 2.5.6.11.4.4 Sequence Number

11

###### 2.5.6.11.4.5 Type

üîπ Authorization Response

###### 2.5.6.11.4.6 Is Synchronous

‚úÖ Yes

###### 2.5.6.11.4.7 Return Message



###### 2.5.6.11.4.8 Has Return

‚ùå No

###### 2.5.6.11.4.9 Is Activation

‚ùå No

###### 2.5.6.11.4.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Internal |
| Method | N/A |
| Parameters | IAM policy document with 'Effect': 'Allow'. API Ga... |
| Authentication | N/A |
| Error Handling | N/A |
| Performance | N/A |

## 2.6.0.0.0.0 Notes

### 2.6.1.0.0.0 Content

#### 2.6.1.1.0.0 Content

RBAC Policy Map is a configuration file (e.g., JSON/YAML) mapping roles to allowed [resource, action] pairs. This should be loaded into memory on service start for performance.

#### 2.6.1.2.0.0 Position

TopRight

#### 2.6.1.3.0.0 Participant Id

user-management-service-003

#### 2.6.1.4.0.0 Sequence Number

7

### 2.6.2.0.0.0 Content

#### 2.6.2.1.0.0 Content

A 401 Unauthorized error is returned for authentication failures (bad token), while a 403 Forbidden error is returned for authorization failures (insufficient permissions). This distinction is critical for security monitoring.

#### 2.6.2.2.0.0 Position

BottomLeft

#### 2.6.2.3.0.0 Participant Id

api-gateway-002

#### 2.6.2.4.0.0 Sequence Number

13

## 2.7.0.0.0.0 Implementation Guidance

| Property | Value |
|----------|-------|
| Security Requirements | JWTs must be signed with RS256. The public key for... |
| Performance Targets | The P99 latency for the entire authorization check... |
| Error Handling Strategy | If the JWT is missing or syntactically invalid, th... |
| Testing Considerations | Unit tests must cover every role and permission co... |
| Monitoring Requirements | A dashboard must be created to monitor the rates o... |
| Deployment Considerations | The RBAC policy configuration should be version-co... |

