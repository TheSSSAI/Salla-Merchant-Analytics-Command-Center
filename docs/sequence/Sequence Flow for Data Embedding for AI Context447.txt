# 1 Overview

## 1.1 Diagram Id

SEQ-DF-003

## 1.2 Name

Data Embedding for AI Context

## 1.3 Description

As part of the CDC pipeline, when a change to a relevant data entity (e.g., a new product is added, a major sales trend is detected) is processed, the pipeline triggers an additional step. This step sends the textual data to an embedding model (via OpenAI API) to create a vector representation, which is then stored in the vector database, scoped to the merchant.

## 1.4 Type

üîπ DataFlow

## 1.5 Purpose

To populate and maintain the vector database with up-to-date, embedded representations of merchant data, which is the foundational 'Retrieval' context for the RAG pattern.

## 1.6 Complexity

High

## 1.7 Priority

üî¥ High

## 1.8 Frequency

OnDemand

## 1.9 Participants

- data-pipeline-processor-014
- openai-gateway-012
- vector-db-repository-011

## 1.10 Key Interactions

- The Data Pipeline Processor receives a change event for a relevant entity (e.g., product created).
- It extracts key textual information (e.g., product name, description).
- It calls the OpenAI Gateway's 'createEmbedding' method with the text.
- The OpenAI API returns a high-dimensional vector.
- The processor then calls the Vector DB Repository to upsert the vector, along with its source metadata (e.g., productId, merchantId), into the vector database.

## 1.11 Triggers

- A CDC event for a data entity relevant to the AI's knowledge base.

## 1.12 Outcomes

- The vector database is populated with searchable context for the AI Assistant.
- The AI can now retrieve this context when answering user queries.

## 1.13 Business Rules

- Embeddings must be stored with a merchantId to ensure strict data isolation.
- PII must be stripped from text before sending it to the embedding model.

## 1.14 Error Scenarios

- The OpenAI embedding API call fails; the step is retried.
- The vector database upsert operation fails.

## 1.15 Integration Points

- OpenAI API (Embedding Models).
- Vector Database (e.g., Pinecone).

# 2.0 Details

## 2.1 Diagram Id

SEQ-DF-003

## 2.2 Name

Data Embedding and Storage for RAG Context

## 2.3 Description

Defines the asynchronous, internal data flow for transforming structured data changes from the CDC pipeline into searchable vector embeddings. This process is triggered by a database change event, extracts and sanitizes textual data, calls an external embedding model via a gateway, and stores the resulting vector in a merchant-scoped vector database. This is a critical backend process that populates the knowledge base for the Retrieval-Augmented Generation (RAG) pattern used by the AI Assistant.

## 2.4 Participants

### 2.4.1 Background Process

#### 2.4.1.1 Repository Id

data-pipeline-processor-014

#### 2.4.1.2 Display Name

Data Pipeline Processor

#### 2.4.1.3 Type

üîπ Background Process

#### 2.4.1.4 Technology

AWS Lambda (Node.js 20.x)

#### 2.4.1.5 Order

1

#### 2.4.1.6 Style

| Property | Value |
|----------|-------|
| Shape | actor |
| Color | #264653 |
| Stereotype | Background Process |

### 2.4.2.0 Gateway

#### 2.4.2.1 Repository Id

openai-gateway-012

#### 2.4.2.2 Display Name

OpenAI Gateway

#### 2.4.2.3 Type

üîπ Gateway

#### 2.4.2.4 Technology

OpenAI Node.js SDK

#### 2.4.2.5 Order

2

#### 2.4.2.6 Style

| Property | Value |
|----------|-------|
| Shape | participant |
| Color | #2A9D8F |
| Stereotype | Infrastructure Gateway |

### 2.4.3.0 Repository

#### 2.4.3.1 Repository Id

vector-db-repository-011

#### 2.4.3.2 Display Name

Vector DB Repository

#### 2.4.3.3 Type

üîπ Repository

#### 2.4.3.4 Technology

Pinecone SDK

#### 2.4.3.5 Order

3

#### 2.4.3.6 Style

| Property | Value |
|----------|-------|
| Shape | database |
| Color | #E9C46A |
| Stereotype | Vector Database |

## 2.5.0.0 Interactions

### 2.5.1.0 Self-Message

#### 2.5.1.1 Source Id

data-pipeline-processor-014

#### 2.5.1.2 Target Id

data-pipeline-processor-014

#### 2.5.1.3 Message

1. Receives and validates `DatabaseChangeCaptured` event

#### 2.5.1.4 Sequence Number

1

#### 2.5.1.5 Type

üîπ Self-Message

#### 2.5.1.6 Is Synchronous

‚úÖ Yes

#### 2.5.1.7 Return Message



#### 2.5.1.8 Has Return

‚ùå No

#### 2.5.1.9 Is Activation

‚úÖ Yes

#### 2.5.1.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Event Trigger (SQS) |
| Method | Lambda Handler Invocation |
| Parameters | SQS Message containing CDC event payload |
| Authentication | IAM Role-based invocation |
| Error Handling | Failed invocation moves message to SQS DLQ after c... |
| Performance | N/A |

#### 2.5.1.11 Nested Interactions

*No items available*

### 2.5.2.0 Self-Message

#### 2.5.2.1 Source Id

data-pipeline-processor-014

#### 2.5.2.2 Target Id

data-pipeline-processor-014

#### 2.5.2.3 Message

2. Extracts text and sanitizes PII from event payload

#### 2.5.2.4 Sequence Number

2

#### 2.5.2.5 Type

üîπ Self-Message

#### 2.5.2.6 Is Synchronous

‚úÖ Yes

#### 2.5.2.7 Return Message



#### 2.5.2.8 Has Return

‚ùå No

#### 2.5.2.9 Is Activation

‚ùå No

#### 2.5.2.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Internal Logic |
| Method | piiSanitizer.clean(text) |
| Parameters | Raw text data (e.g., product description) |
| Authentication | N/A |
| Error Handling | Logs a warning if sanitization patterns fail but d... |
| Performance | p99 < 20ms |

#### 2.5.2.11 Nested Interactions

*No items available*

### 2.5.3.0 Method Call

#### 2.5.3.1 Source Id

data-pipeline-processor-014

#### 2.5.3.2 Target Id

openai-gateway-012

#### 2.5.3.3 Message

3. createEmbedding(sanitizedText: string): Promise<number[]>

#### 2.5.3.4 Sequence Number

3

#### 2.5.3.5 Type

üîπ Method Call

#### 2.5.3.6 Is Synchronous

‚úÖ Yes

#### 2.5.3.7 Return Message

3.1. returns embeddingVector: number[]

#### 2.5.3.8 Has Return

‚úÖ Yes

#### 2.5.3.9 Is Activation

‚úÖ Yes

#### 2.5.3.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTPS/REST |
| Method | OpenAIGateway.createEmbedding |
| Parameters | { text: string, model: 'text-embedding-3-small' } |
| Authentication | Gateway uses managed API Key from AWS Secrets Mana... |
| Error Handling | Throws 'EmbeddingServiceError'. Implements a retry... |
| Performance | p95 latency < 1500ms |

#### 2.5.3.11 Nested Interactions

*No items available*

### 2.5.4.0 Method Call

#### 2.5.4.1 Source Id

data-pipeline-processor-014

#### 2.5.4.2 Target Id

vector-db-repository-011

#### 2.5.4.3 Message

4. upsertVector(vectorData: VectorUpsertDTO): Promise<void>

#### 2.5.4.4 Sequence Number

4

#### 2.5.4.5 Type

üîπ Method Call

#### 2.5.4.6 Is Synchronous

‚úÖ Yes

#### 2.5.4.7 Return Message

4.1. returns success confirmation

#### 2.5.4.8 Has Return

‚úÖ Yes

#### 2.5.4.9 Is Activation

‚úÖ Yes

#### 2.5.4.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | gRPC (via Pinecone SDK) |
| Method | VectorDBRepository.upsertVector |
| Parameters | VectorUpsertDTO: { id: string (e.g., product:UUID)... |
| Authentication | Repository uses managed API Key from AWS Secrets M... |
| Error Handling | Throws 'VectorDBError' on failure. This is conside... |
| Performance | p95 latency < 500ms for single vector upsert |

#### 2.5.4.11 Nested Interactions

*No items available*

## 2.6.0.0 Notes

### 2.6.1.0 Content

#### 2.6.1.1 Content

Process is initiated by a message from a CDC event queue (e.g., AWS SQS) containing the `DatabaseChangeCaptured` event payload. The processor is designed to handle events in batches for efficiency.

#### 2.6.1.2 Position

top-left

#### 2.6.1.3 Participant Id

data-pipeline-processor-014

#### 2.6.1.4 Sequence Number

1

### 2.6.2.0 Content

#### 2.6.2.1 Content

The 'upsert' operation is critical. It ensures that if an entity's text is updated, its vector representation is overwritten, keeping the RAG context fresh and preventing stale data.

#### 2.6.2.2 Position

bottom-right

#### 2.6.2.3 Participant Id

vector-db-repository-011

#### 2.6.2.4 Sequence Number

4

## 2.7.0.0 Implementation Guidance

| Property | Value |
|----------|-------|
| Security Requirements | API Keys for OpenAI and Pinecone must be stored in... |
| Performance Targets | The end-to-end processing time for a single event ... |
| Error Handling Strategy | The entire process is asynchronous and must be res... |
| Testing Considerations | Unit tests for the `data-pipeline-processor-014` m... |
| Monitoring Requirements | Monitor the `data_pipeline_dlq` size; an alert mus... |
| Deployment Considerations | This is a core component of the data pipeline. Con... |

