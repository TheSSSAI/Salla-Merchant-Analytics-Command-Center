flowchart TD
    %% Entry Point
    UserInteraction((User Clicks\nFilter Trigger)) --> InitState

    subgraph Component_Logic [Date Range Component State]
        InitState[Initialize Local State\nDefault: Current Global Selection]
        InitState --> RenderPopover{Render Popover}
        
        %% Paths
        RenderPopover -->|Tab: Presets| ViewPresets[Display Presets List\nToday, Last 7, Last 30, etc.]
        RenderPopover -->|Tab: Custom| ViewCalendar[Display Calendar UI\nStart & End Inputs]

        %% Path A: Preset Selection
        ViewPresets --> SelectPreset(User Clicks Preset)
        SelectPreset --> CalcPreset[Calculate Start & End Dates\nbased on current time]
        CalcPreset --> UpdateLabel[Update Button Label]
        UpdateLabel --> ApplyLogic

        %% Path B: Custom Selection
        ViewCalendar --> InputStart(User Selects Start Date)
        InputStart --> SetStart[Set tempStartDate]
        SetStart --> CheckEndExists{Is tempEndDate\nSet?}
        
        CheckEndExists -- No --> WaitEnd[Wait for End Selection]
        CheckEndExists -- Yes --> ValidateRange
        
        WaitEnd --> InputEnd(User Selects End Date)
        InputEnd --> SetEnd[Set tempEndDate]
        SetEnd --> ValidateRange{Validation Check\nBR-DATE-001}
        
        %% Validation Logic
        ValidateRange -- "Start > End (Invalid)" --> InvalidState[Set Error State]
        InvalidState --> ShowError[Display Inline Error:\n'End date cannot be before start']
        ShowError --> DisableApply[Disable 'Apply' Button]
        DisableApply --> InputEnd
        
        ValidateRange -- "Start <= End (Valid)" --> ValidState[Clear Error State]
        ValidState --> EnableApply[Enable 'Apply' Button]
        
        %% Apply Action
        EnableApply --> ClickApply(User Clicks 'Apply')
        ClickApply --> ApplyLogic
    end

    subgraph Global_Effect [Application State & Side Effects]
        ApplyLogic[[Commit State Change]]
        ApplyLogic --> UpdateURL[Update URL Query Params\n?from=YYYY-MM-DD&to=...]
        UpdateURL --> TriggerFetch[Trigger Data Refetch\nShow Loading Skeletons]
        TriggerFetch --> ClosePopover((Close Popover))
    end

    %% Styling
    classDef interaction fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,color:#0d47a1
    classDef logic fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#4a148c
    classDef error fill:#ffebee,stroke:#c62828,stroke-width:2px,color:#b71c1c
    classDef success fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px,color:#1b5e20
    classDef system fill:#fff3e0,stroke:#ef6c00,stroke-width:2px,color:#e65100

    class UserInteraction,SelectPreset,InputStart,InputEnd,ClickApply interaction
    class InitState,CalcPreset,SetStart,SetEnd,CheckEndExists,ValidateRange logic
    class InvalidState,ShowError,DisableApply error
    class ValidState,EnableApply success
    class UpdateURL,TriggerFetch,ClosePopover,UpdateLabel,ApplyLogic,ViewPresets,ViewCalendar system