flowchart TD
    %% Theme & Styling
    classDef actor fill:#e0f2f1,stroke:#00695c,stroke-width:2px,color:#004d40
    classDef logic fill:#fff3e0,stroke:#ef6c00,stroke-width:2px,color:#e65100
    classDef ui fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,color:#0d47a1
    classDef api fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#4a148c
    classDef error fill:#ffebee,stroke:#c62828,stroke-width:2px,color:#b71c1c
    classDef success fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px,color:#1b5e20

    subgraph Initialization [Page Load & Hydration]
        Start([User Visits Dashboard]) --> CheckURL{URL Has Date Params?}
        CheckURL -- Yes --> ParseParams[Parse Start/End Dates]
        CheckURL -- No --> DefaultState[Set Default: 'Last 30 Days']
        ParseParams --> SetInternalState[Set Internal Component State]
        DefaultState --> SetInternalState
    end

    subgraph Interaction [User Interaction]
        SetInternalState --> RenderUI[Render Date Picker UI]
        RenderUI --> UserClick(User Clicks Filter)
        UserClick --> OpenPopover[Open Popover Menu]
        OpenPopover --> SelectionType{Selection Type?}
        
        %% Preset Flow
        SelectionType -- Preset --> SelectPreset[Select 'Last 7 Days', 'YTD', etc.]
        SelectPreset --> UpdateState[Update Internal State]

        %% Custom Flow
        SelectionType -- Custom Range --> OpenCalendar[Show Calendar View]
        OpenCalendar --> PickDates[User Selects Start & End Date]
        PickDates --> Validate{Start Date <= End Date?}
        Validate -- No --> ShowValError[Display 'Invalid Range' Error]:::error
        ShowValError --> DisableApply[Disable 'Apply' Button]
        DisableApply --> PickDates
        Validate -- Yes --> EnableApply[Enable 'Apply' Button]
        EnableApply --> UserApply(User Clicks Apply)
        UserApply --> UpdateState
    end

    subgraph Execution [System Execution]
        UpdateState --> UpdateURL[Update URL Query Params\n(pushState)]:::logic
        UpdateURL --> SetLoading[Set Dashboard Loading State\n(Skeleton UI)]:::ui
        SetLoading --> FetchData[GET /api/analytics/dashboard\n?start=...&end=...]:::api
        
        FetchData --> ApiResponse{API Response?}
    end

    subgraph Outcome [Result Handling]
        ApiResponse -- 200 OK (Data) --> RenderCharts[Render Charts & KPIs]:::success
        ApiResponse -- 200 OK (Empty) --> RenderEmpty[Show 'No Data Available' Msg]:::ui
        ApiResponse -- 4xx/5xx Error --> RenderError[Show Error Toast/Banner]:::error
        
        RenderCharts --> StopLoading[Remove Skeleton UI]
        RenderEmpty --> StopLoading
        RenderError --> StopLoading
    end

    %% Styles
    class Start,UserClick,UserApply actor
    class CheckURL,ParseParams,Validate,SelectionType,ApiResponse logic
    class RenderUI,OpenPopover,OpenCalendar,ShowValError,SetLoading,RenderCharts,RenderEmpty,RenderError ui
    class FetchData api